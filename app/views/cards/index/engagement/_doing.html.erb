<section id="doing-cards" class="cards cards--doing is-collapsed" style="--card-color: <%= stage.color if defined?(stage) && stage %>"
    data-controller="toggle-class" data-toggle-class-toggle-class="is-collapsed">
  <% 
    filtered_records = if defined?(stage) && stage
      page.records.select { |card| card.stage == stage }
    else
      page.records
    end
  %>

  <div class="cards__expander btn btn--plain">
    <strong class="font-weight-black cards__expander-count"><%= filtered_records.count %></strong>
    <button class="btn btn--plain cards__expander-button txt-uppercase" data-action="toggle-class#toggle"><%= stage.name if defined?(stage) && stage %></button>
  </div>

  <% if filtered_records.any? %>
    <%= render partial: "cards/display/preview", collection: filtered_records, as: :card, locals: { draggable: true }, cached: ->(card) { cacheable_preview_parts_for(card) } %>

    <% unless page.last? %>
      <div class="full-width">
        <%= cards_next_page_link "doing-cards", page: page, filter: filter %>
      </div>
    <% end %>
  <% else %>
    <p class="txt-normal translucent blank-slate"><%= user_filtering.any? ? "No matches" : "Nothing here" %></p>
  <% end %>
</section>
